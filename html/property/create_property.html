{% extends 'layouts/master.html' %}
{% load static %}

{% block title %}
Address PMS | Create Property
{% endblock title %}



{% block content %}
<div class="card mb-3">
    <div class="card-header">
        <div class="row flex-between-end">
            <div class="col-auto align-self-center">
                <h5 class="mb-0" data-anchor="data-anchor"><i class="fa-solid fa-house me-2"></i>Create Property</h5>
            </div>
        </div>
    </div>
    <div class="card-body bg-light">
        <div class="tab-content">

            <form class="row g-3 needs-validation" novalidate="" method="POST" enctype="multipart/form-data">
                {% csrf_token %}
                <!-- <h5><i class="fa-solid fa-house-user me-2"></i>Property Information</h5> -->
                <div class="col-md-6">
                    <label class="form-label" for="validationCustom01">
                        <i class="fa-solid fa-user me-2">
                        </i>Property Owner
                    </label>
                    {{ form.user }}
                </div>

                <div class="col-md-6">
                    <label class="form-label" for="validationCustom01">
                        <i class="fa-solid fa-bars me-2"></i>Property Title
                    </label>
                    {{ form.title }}
                </div>

                <div class="col-md-6">
                    <label class="form-label" for="validationCustom01">
                        <i class="fa-solid fa-chart-area me-2"></i>Property Size
                        <span>(Square Feet - ftÂ²)</span>
                    </label>
                    {{ form.size }}
                    {% for error in form.size.errors %}
                    <div class="invalid-feedback">
                        {{ error }}
                    </div>
                    {% endfor %}
                </div>

                <div class="col-md-6">
                    <label class="form-label" for="validationCustom01">
                        <!-- <i class="fa-regular fa-money-bill-1 me-2"></i></i> -->
                        <i class="fa-solid fa-bangladeshi-taka-sign fs-1 me-2"></i>
                        Property Price
                    </label>
                    {{ form.price }}
                    {% for error in form.price.errors %}
                    <div class="invalid-feedback">
                        {{ error }}
                    </div>
                    {% endfor %}
                </div>

                <div class="col-md-6">
                    <label class="form-label" for="validationCustom01">
                        <i class="fa-solid fa-bed me-2"></i>Property Bed
                    </label>
                    {{ form.bed }}
                </div>

                <div class="col-md-6">
                    <label class="form-label" for="validationCustom01">
                        <i class="fa-solid fa-bath me-2"></i>Property Bath
                    </label>
                    {{ form.bath }}
                </div>

                <div class="col-md-6">
                    <label class="form-label" for="validationCustom01">
                        <i class="fa-brands fa-youtube me-2"></i>Property Video
                    </label>
                    {{ form.video }}
                </div>

                <div class="col-md-6">
                    <label class="form-label" for="validationCustom01">
                        <i class="fa-solid fa-hotel me-2"></i>Property Floor Plans
                    </label>
                    {{ form.floor_plans }}
                </div>

                <!--  -->
                <div class="border-dashed-bottom my-2"></div>
                <!--  -->

                <div class="col-md-6">
                    <label class="form-label" for="validationCustom01">
                        <i class="fa-solid fa-house-laptop me-2"></i>Property Features
                    </label>
                    {{ form.property_features }}
                </div>

                <div class="col-md-6">
                    <label class="form-label" for="validationCustom01">
                        <i class="fa-solid fa-hand-holding-dollar me-2"></i>Property Purpose
                    </label>
                    {{ form.property_purpose }}
                </div>

                <div class="col-md-6">
                    <label class="form-label" for="validationCustom01">
                        <i class="fa-solid fa-city me-2"></i>Property Type
                    </label>
                    {{ form.property_type }}
                </div>

                <div class="col-md-6">
                    <label class="form-label" for="sub-type">
                        <i class="fa-solid fa-shop me-2"></i>Property Sub-Type
                    </label>
                    <select class="form-select" id="id_sub_type" size="1" style="height: 42px;" name="sub_type"
                        data-options='{"removeItemButton":true,"placeholder":true}'>
                        <option disabled selected>Select sub type</option>
                    </select>
                </div>

                <div class="col-md-6">
                    <label class="form-label" for="validationCustom01">
                        <i class="fa-solid fa-user-tie me-2"></i>Manage By Address-PMS
                    </label>
                    <div class="form-check form-switch">
                        <input class="form-check-input" id="id_manage_by" type="checkbox" name="manage_by" checked="" />
                    </div>
                </div>

                <div class="col-md-6 form-check ">
                    <label class="form-label" for="id_hot_deals">
                        <i class="fa-solid fa-star me-2"></i>Hot Deals
                    </label>
                    <!-- <div class="form-check form-switch">
                        <input class="form-check-input" id="id_hot_deals" type="checkbox" name="hot_deals"/>
                    </div> -->
                    {{ form.hot_deals }}
                </div>

                <!--  -->
                <div class="border-dashed-bottom my-2"></div>
                <!--  -->

                <div class="d-block ms-3">
                    <h5><i class="fa-solid fa-location-dot me-2"></i>Property Address</h5>
                    <div class="col-md-6">
                        <label class="form-label" for="validationCustom01">City</label>
                        {{ form.property_address_form.city }}
                    </div>

                    <div class="col-md-6 ">
                        <label class="form-label" for="validationCustom01">Home Address</label>
                        {{ form.property_address_form.location }}
                    </div>
                </div>

                <!--  -->
                <div class="border-dashed-bottom my-2"></div>
                <!--  -->


                <div class="d-block ms-3">
                    <h5><i class="fa-solid fa-file-lines me-2"></i>Property Descriptsion</h5>
                    <div class="col-md-12">
                        {{ form.description }}
                    </div>
                </div>

                <div class="col-md-6 ms-3">
                    <h5 class="mb-3"><i class="fa-brands fa-creative-commons-sampling-plus me-2"></i>Property Status</h5>
                    <!-- <label class="form-label" for="validationCustom01"></label> -->
                    {{ form.property_status }}
                </div>

                <!--  -->
                <div class="border-dashed-bottom my-2"></div>
                <!--  -->

                <div class="col-md-12 col-sm-10 ms-3">
                    <h5><i class="fa-solid fa-camera-retro me-2"></i>Property Images</h5>

                    <div class="col-md-6 col-sm-4 form-group row" id="multiple_files">
                        <input type="file" name="content_files" class="form-control ms-3 mt-2" id="content_files"
                            multiple>
                    </div>

                    <div class="row mt-3" id="file_list">
                    </div>

                </div>

                <div class="col-md-12 mt-3 ms-3">
                    <h5><i class="fa fa-tags"></i> Property Keyword</h5>
                    <div class="col-md-6 tag-input">
                        <div class="input d-flex justify-content-between">
                            <input type="text" name="keyword" class="form-control mt-2" id="tag-ip"
                                placeholder="Enter Keyword">
                            <button class="btn btn-primary ms-1 mt-2" type="button" onclick="addKeyword()">Add</button>

                            <!-- Hidden input field to store keywords -->
                            <input type="hidden" name="keywords" id="hidden-keywords" value="">
                        </div>
                        <div class="col-md-12 keyword-list mt-3"
                            style="border: 1px solid #ccc; min-height: 100px; padding: 10px; border-radius: 5px;">
                        </div>
                    </div>
                </div>

                <div class="card-footer">
                    <div class="row">
                        <div class="col-md-9 d-flex">
                            <button type="submit" class="btn btn-primary me-2">
                                <i class="fa fa-save me-2"></i>
                                Create
                            </button>
                            <a href="" class="btn btn-secondary">
                                <i class="fa fa-times me-2"></i>
                                Cancel
                            </a>
                        </div>
                    </div>
                </div>
            </form>

        </div>
    </div>
</div>




<script src="https://code.jquery.com/jquery-3.7.1.js" integrity="sha256-eKhayi8LEQwp4NKxN+CfCh+3qOVUtJn3QNZ0TciWLP4="
    crossorigin="anonymous"></script>


<script>
    $(document).ready(function () {
        let counter = 0;

        $("#add_more_image").click(function (e) {
            e.preventDefault();

            counter++;

            // Clone the image input field and update its name and id
            const imageField = $("#id_property_image_form-image");
            const clonedImageField = imageField.clone();
            clonedImageField.attr("name", `property_image_form-image-${counter}`);
            clonedImageField.attr("id", `id_property_image_form-image-${counter}`);

            const sub_type_field = `
        <div class="show_item">
            <div class="row">
                <div class="col-md-10">
                    <label class="form-label" for="validationCustom01">Property Image</label>
                    ${clonedImageField[0].outerHTML}
                </div>
                <div class="col-md-2" style="margin-top: 32px;">
                    <button class="btn btn-danger btn-sm remove_btn" data-counter="${counter}">
                        Remove
                    </button>
                </div>
            </div>
        </div>
        `;

            $("#show_item").prepend(sub_type_field);
        });

        // Remove the sub type field
        $("#show_item").on("click", ".remove_btn", function () {
            $(this).closest(".show_item").remove();
        });


    });

</script>

<script>

    $(document).ready(function () {
        var propertyTypeSelect = $('#id_property_type');
        var subTypeSelect = $('#id_sub_type');

        console.log("Domen =", window.location.host)

        propertyTypeSelect.on('change', function () {
            var selectedValue = $(this).val();
            // console.log('Selected Property Type PK:', selectedValue);

            // Make an AJAX GET request to the API with the selected PK
            $.ajax({
                type: 'GET',
                // url: `http://${window.location.host}/apis/property/property-subtypes/${selectedValue}/`,
                url: `${window.location.protocol}//${window.location.host}/apis/property/property-subtypes/${selectedValue}/`,

                dataType: 'json',
                success: function (data) {
                    subTypeSelect.empty();

                    subTypeSelect.append($('<option>', {
                        value: '',
                        text: '------------------',
                        disabled: true,
                        selected: true, // You can also add this to make it the default selected option
                    }));

                    if (data && data.length > 0) {
                        data.forEach(function (item) {
                            console.log("Item ID = %s , Item Name = %s", item.id, item.sub_type);
                            subTypeSelect.append($('<option>', {
                                value: item.id,
                                text: item.sub_type
                            }));
                        });
                    } else {
                        // Handle the case where no data is received
                        subTypeSelect.append($('<option>', {
                            value: '',
                            text: 'No sub-types available'
                        }));
                    }
                },
                error: function (error) {
                    console.error('Error fetching data:', error);
                }
            });
        });
    });


</script>

<script>
    var fieldErrors = {{ field_errors| safe }};

    $(document).ready(function () {

        if (fieldErrors.size.length > 0) {
            $('#size').addClass('is-invalid');
        }

        if (fieldErrors.price.length > 0) {
            $('#price').addClass('is-invalid');
        }

    });
</script>

{% endblock content %}

{% block js %}
<script>
    $(document).ready(function () {

        const clear_input_file_btn_template = (id) => `
        <div class="position-relative" style="top: 24px; right: 4px; z-index: 1; cursor: pointer;">
            <button type="button" class="btn btn-sm btn-danger clear-file" data-file-id="${id}">
                <i class="fa fa-times"></i>
            </button>
        </div>
        `;

        const img_template = (id, url) => `
        <div class="col-auto" id="filepreview_${id}">
            ${clear_input_file_btn_template(id)}
            <img src="${url}" alt="content image" class="img-fluid" style="max-height: 100px;">
        </div>
        `;

        function render_type_with_input(type) {
            $('#content_files').attr({
                'accept': 'image/*',
                'required': 'required',
                'multiple': 'multiple'
            })
        }

        $("#id_type").change(function () {
            render_type_with_input($(this).val());
            // clear file input
            $('#content_files').val('');
            $('#content_files').trigger('change');
        });
        render_type_with_input($('#id_type').val());


        $("#content_files").change(function () {
            for (let i = 0; i < this.files.length; i++) {
                const file = this.files[i];
                const url = URL.createObjectURL(file);
                $('#file_list').append(img_template(i, url));
            }
        });

        $('#file_list').on('click', '.clear-file', function () {
            const fileId = $(this).data('file-id');

            $(`#filepreview_${fileId}`).remove();
            $(`#filepreview_${fileId}`).remove();

            // Remove the file from the input field
            const fileInput = $('#content_files')[0];
            const dataTransfer = new DataTransfer();

            Array.from(fileInput.files).forEach((file, index) => {
                if (index !== fileId) {
                    dataTransfer.items.add(file);
                }
            });

            fileInput.files = dataTransfer.files;

        });

    });
</script>


<!-- For Keyword -->
<script>
    let keywords = [];

    function addKeyword() {
        let keywordInput = document.getElementById("tag-ip");
        let keyword = keywordInput.value.trim();

        if (keyword.length < 1 || keywords.includes(keyword)) {
            keywordInput.value = '';
            return;
        }

        keywords.push(keyword);

        let keywordItem = document.createElement("span");
        keywordItem.classList.add("badge", "bg-primary", "m-1", "p-2");
        keywordItem.innerHTML = `
    ${keyword}
    <i class="delete-btn ms-1 fas fa-times" onclick="deleteKeyword(this, '${keyword}')"></i>
  `;

        document.querySelector(".tag-input .keyword-list").appendChild(keywordItem);
        keywordInput.value = '';

        // Update hidden input value
        updateHiddenInput();
    }

    function deleteKeyword(ref, keyword) {
        let parent = ref.parentNode;
        parent.parentNode.removeChild(parent);
        let index = keywords.indexOf(keyword);
        keywords.splice(index, 1);

        // Update hidden input value
        updateHiddenInput();
    }

    function updateHiddenInput() {
        const hiddenInput = document.getElementById("hidden-keywords");
        if (hiddenInput) {
            hiddenInput.value = JSON.stringify(keywords);
        }
    }
</script>
{% endblock js %}